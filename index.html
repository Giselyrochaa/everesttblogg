<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vota√ß√£o Blog Evereste: Temas de Inova√ß√£o e Sustentabilidade</title>
    <!-- Carregamento do Tailwind CSS para estiliza√ß√£o r√°pida e responsiva -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Configura√ß√£o da fonte Inter -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f9fb; /* Fundo mais claro e suave */
        }
    </style>
</head>
<body class="min-h-screen flex flex-col antialiased">

    <!-- Mensagem de Confirma√ß√£o/Alerta -->
    <div id="message-box" class="fixed top-4 right-4 z-50 transition-transform transform translate-x-full duration-500 ease-out">
        <div id="message-content" class="bg-indigo-600 text-white font-semibold py-3 px-6 rounded-lg shadow-xl flex items-center space-x-2">
            <!-- √çcone e Texto s√£o preenchidos via JavaScript -->
        </div>
    </div>

    <header class="bg-white shadow-md">
        <div class="max-w-7xl mx-auto py-6 px-4 sm:px-6 lg:px-8">
            <h1 class="text-3xl font-extrabold text-gray-900">
                üó≥Ô∏è Vota√ß√£o Evereste Blog
            </h1>
            <p class="mt-1 text-lg text-gray-500">
                Vote nos temas que voc√™ gostaria de ver em destaque em Inova√ß√£o, A√ß√£o Social e Sustentabilidade.
            </p>
        </div>
    </header>

    <main class="flex-grow max-w-7xl mx-auto py-8 sm:px-6 lg:px-8 w-full">
        <!-- Container Principal da Vota√ß√£o -->
        <div id="voting-container" class="grid grid-cols-1 md:grid-cols-3 gap-8">
            <!-- Conte√∫do carregado e gerenciado via JavaScript -->
            <p id="loading-text" class="col-span-3 text-center text-gray-500 text-lg">
                Carregando dados da vota√ß√£o...
            </p>
        </div>
    </main>

    <footer class="bg-gray-800 text-white py-4 mt-8">
        <div class="max-w-7xl mx-auto text-center">
            <p>&copy; 2025 Blog Evereste. Todos os direitos reservados. | Vota√ß√£o em tempo real com Firebase.</p>
        </div>
    </footer>

    <!-- Firebase Imports -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, onSnapshot, runTransaction, increment } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Vari√°veis globais obrigat√≥rias no ambiente Canvas
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        // Configura√ß√£o de Log do Firestore
        // setLogLevel('Debug'); // Descomente para debug

        // Inicializa o Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        const VOTING_DOC_PATH = `/artifacts/${appId}/public/data/evereste_voting/voting_data`;
        const docRef = doc(db, VOTING_DOC_PATH);

        // Estrutura inicial dos dados (usada se o documento n√£o existir)
        const initialData = {
            categories: {
                tecnologia_inovacao: {
                    name: "Tecnologia e Inova√ß√£o",
                    color: "bg-indigo-500",
                    themes: {
                        ia_impacto: { name: "Intelig√™ncia Artificial e Impacto Social", votes: 0, icon: "üí°" },
                        inclusao_digital: { name: "Inclus√£o Digital e Equidade Tecnol√≥gica", votes: 0, icon: "üíª" },
                        computacao_quantica: { name: "Computa√ß√£o Qu√¢ntica", votes: 0, icon: "‚öõÔ∏è" }
                    }
                },
                acao_social: {
                    name: "A√ß√£o Social",
                    color: "bg-emerald-500",
                    themes: {
                        engajamento_comunitario: { name: "Engajamento Comunit√°rio e Inova√ß√£o", votes: 0, icon: "ü§ù" },
                        diversidade_inclusao: { name: "Diversidade Inclus√£o no Ecossistema de Inova√ß√£o", votes: 0, icon: "üåà" },
                        voluntariado_tecnologico: { name: "Voluntariado Tecnol√≥gico", votes: 0, icon: "‚öôÔ∏è" }
                    }
                },
                sustentabilidade_cop30: {
                    name: "Sustentabilidade e COP30",
                    color: "bg-amber-500",
                    themes: {
                        cop30_amazonia: { name: "COP30 e o Futuro da Amaz√¥nia", votes: 0, icon: "üå≥" },
                        bioeconomia: { name: "Bioeconomia e Inova√ß√£o Verde", votes: 0, icon: "üå±" },
                        transicao_energetica: { name: "Transi√ß√£o Energ√©tica e Inova√ß√£o", votes: 0, icon: "‚ö°" }
                    }
                }
            }
        };

        let totalVotes = 0;

        /**
         * Exibe uma mensagem de alerta ou confirma√ß√£o personalizada.
         * @param {string} message A mensagem a ser exibida.
         * @param {string} type O tipo de mensagem ('success' ou 'error').
         */
        function showMessage(message, type) {
            const box = document.getElementById('message-box');
            const content = document.getElementById('message-content');
            
            // Define estilos com base no tipo
            let bgColor = type === 'success' ? 'bg-green-600' : 'bg-red-600';
            let icon = type === 'success' ? '‚úÖ' : '‚ùå';

            content.className = `py-3 px-6 rounded-lg shadow-xl flex items-center space-x-2 ${bgColor}`;
            content.innerHTML = `${icon} <span class="text-sm">${message}</span>`;
            
            // Mostra a caixa
            box.classList.remove('translate-x-full');
            
            // Esconde a caixa ap√≥s 3 segundos
            setTimeout(() => {
                box.classList.add('translate-x-full');
            }, 3000);
        }

        /**
         * Renderiza a interface de vota√ß√£o e resultados.
         * @param {object} categories Dados da vota√ß√£o com votos atualizados.
         */
        function renderVotingUI(categories) {
            const container = document.getElementById('voting-container');
            container.innerHTML = '';
            
            totalVotes = Object.values(categories).flatMap(cat => 
                Object.values(cat.themes).map(theme => theme.votes)
            ).reduce((sum, votes) => sum + votes, 0);

            // Se n√£o houver votos, define um total de 1 para evitar divis√£o por zero,
            // mas o c√°lculo de percentual n√£o ser√° exibido de qualquer forma.
            const displayTotalVotes = totalVotes === 0 ? 1 : totalVotes;

            // Renderiza cada categoria
            Object.entries(categories).forEach(([catKey, category]) => {
                const categoryCard = document.createElement('div');
                categoryCard.className = `bg-white p-6 rounded-xl shadow-lg border-t-8 ${category.color} flex flex-col h-full`;
                categoryCard.innerHTML = `
                    <h2 class="text-2xl font-bold mb-4 text-gray-800">${category.name}</h2>
                    <div id="themes-${catKey}" class="space-y-4 flex-grow">
                        <!-- Temas ser√£o inseridos aqui -->
                    </div>
                `;
                
                const themesContainer = categoryCard.querySelector(`#themes-${catKey}`);
                
                // Renderiza cada tema
                Object.entries(category.themes).forEach(([themeKey, theme]) => {
                    const percentage = totalVotes > 0 ? ((theme.votes / displayTotalVotes) * 100).toFixed(1) : '0.0';
                    
                    const themeElement = document.createElement('div');
                    themeElement.className = 'bg-gray-50 p-4 rounded-lg shadow-sm border border-gray-200 hover:shadow-md transition duration-300';
                    themeElement.innerHTML = `
                        <div class="flex items-start justify-between">
                            <h3 class="font-semibold text-lg text-gray-700 leading-tight">
                                ${theme.icon} ${theme.name}
                            </h3>
                            <div class="text-2xl font-extrabold text-indigo-600">${theme.votes}</div>
                        </div>
                        
                        <!-- Barra de Progresso/Resultados -->
                        <div class="mt-2 w-full bg-gray-200 rounded-full h-2.5">
                            <div 
                                class="h-2.5 rounded-full ${category.color.replace('500', '600')}"
                                style="width: ${percentage}%; transition: width 0.5s ease-in-out;">
                            </div>
                        </div>
                        
                        <div class="flex justify-between items-center mt-3">
                            <span class="text-xs font-medium text-gray-500">${percentage}% dos votos</span>
                            <button 
                                id="vote-btn-${catKey}-${themeKey}" 
                                class="px-4 py-1 text-sm font-semibold text-white transition duration-300 rounded-full shadow-md hover:shadow-lg focus:outline-none focus:ring-4 ${category.color} hover:${category.color.replace('500', '600')}"
                                data-cat-key="${catKey}" 
                                data-theme-key="${themeKey}">
                                Votar
                            </button>
                        </div>
                    `;
                    themesContainer.appendChild(themeElement);

                    // Adiciona o listener de clique ao bot√£o de voto
                    themeElement.querySelector(`#vote-btn-${catKey}-${themeKey}`).addEventListener('click', handleVote);
                });
                
                container.appendChild(categoryCard);
            });
        }

        /**
         * Fun√ß√£o principal de vota√ß√£o.
         * Lida com o clique e executa a transa√ß√£o no Firestore.
         * @param {Event} event O evento de clique.
         */
        async function handleVote(event) {
            const button = event.currentTarget;
            const catKey = button.getAttribute('data-cat-key');
            const themeKey = button.getAttribute('data-theme-key');
            
            // Desabilita o bot√£o para evitar cliques duplos
            button.disabled = true;
            button.textContent = 'Votando...';
            button.classList.add('opacity-50');

            try {
                // Aumenta a contagem de votos para o tema espec√≠fico
                const themePath = `categories.${catKey}.themes.${themeKey}.votes`;

                await runTransaction(db, async (transaction) => {
                    const sfDoc = await transaction.get(docRef);
                    
                    if (!sfDoc.exists()) {
                        // Se o documento n√£o existir, usa a estrutura inicial
                        const newData = JSON.parse(JSON.stringify(initialData));
                        newData.categories[catKey].themes[themeKey].votes = 1; // 1¬∫ voto
                        transaction.set(docRef, newData);
                    } else {
                        // Incrementa o campo espec√≠fico de forma segura
                        transaction.update(docRef, {
                            [themePath]: increment(1)
                        });
                    }
                });

                const themeName = initialData.categories[catKey].themes[themeKey].name;
                showMessage(`Seu voto em "${themeName}" foi registrado com sucesso!`, 'success');

            } catch (e) {
                console.error("Falha na transa√ß√£o (voto): ", e);
                showMessage('Houve um erro ao registrar seu voto. Tente novamente.', 'error');
            } finally {
                // Reabilita o bot√£o ap√≥s a transa√ß√£o
                button.disabled = false;
                button.textContent = 'Votar';
                button.classList.remove('opacity-50');
            }
        }


        /**
         * Inicializa√ß√£o do Firebase e Listeners
         */
        async function initialize() {
            try {
                // 1. Autentica√ß√£o:
                // √â necess√°rio que o usu√°rio esteja autenticado (request.auth != null) para votar.
                // Se houver um token customizado (ambiente Canvas), ele √© usado. Caso contr√°rio,
                // o usu√°rio √© autenticado anonimamente (o que satisfaz a regra de escrita do Firestore).
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    // Autentica√ß√£o an√¥nima para permitir a vota√ß√£o
                    await signInAnonymously(auth);
                }
                
                // 2. Listener em tempo real (onSnapshot)
                onSnapshot(docRef, (doc) => {
                    document.getElementById('loading-text')?.remove(); // Remove o texto de loading
                    
                    if (doc.exists()) {
                        // Documento existe, renderiza com os dados atualizados
                        const data = doc.data();
                        renderVotingUI(data.categories);
                    } else {
                        // Documento n√£o existe, renderiza com a estrutura inicial (0 votos)
                        renderVotingUI(initialData.categories);
                        console.log("Documento de vota√ß√£o n√£o encontrado. Usando dados iniciais.");
                        
                        // O primeiro voto criar√° o documento (tratado em handleVote)
                    }
                }, (error) => {
                    console.error("Erro no listener do Firestore:", error);
                    document.getElementById('voting-container').innerHTML = `
                        <p class="col-span-3 text-center text-red-600 text-xl">
                            ‚ùå Erro ao carregar os dados: ${error.message}
                        </p>
                    `;
                });

            } catch (error) {
                console.error("Erro na inicializa√ß√£o ou autentica√ß√£o do Firebase:", error);
                
                // --- NOVO TRATAMENTO DE ERRO VIS√çVEL ---
                const container = document.getElementById('voting-container');
                container.innerHTML = `
                    <div class="col-span-3 text-center p-8 bg-red-100 border border-red-400 text-red-700 rounded-xl shadow-md mx-auto max-w-lg">
                        <p class="text-xl font-bold mb-2">‚ùå ERRO CR√çTICO DE INICIALIZA√á√ÉO</p>
                        <p class="mt-2">N√£o foi poss√≠vel conectar ou autenticar no Firebase.</p>
                        <p class="text-sm mt-1 font-mono break-all">Detalhes (Console): ${error.message}</p>
                        <p class="mt-4 text-sm">Certifique-se de que a configura√ß√£o do ambiente est√° correta.</p>
                    </div>
                `;
                // --- FIM DO NOVO TRATAMENTO ---

                showMessage('Falha na conex√£o com o sistema de vota√ß√£o.', 'error');
            }
        }

        // Garante que a inicializa√ß√£o comece ap√≥s o carregamento da p√°gina
        window.onload = initialize;

    </script>
</body>
</html>
